---
groups:
  - name: node-base
    rules:
    - record: instance:node_cpus:count
      expr: count(node_cpu{mode="idle"}) WITHOUT (cpu, mode)

    - record: instance_cpu:node_cpu_not_idle:rate5m
      expr: sum(rate(node_cpu{mode!="idle"}[5m])) WITHOUT (mode)

    - record: instance_mode:node_cpu:rate5m
      expr: sum(rate(node_cpu[5m])) WITHOUT (cpu)

    - alert: NodeLowDiskSpace
      expr: node_filesystem_avail{fstype=~"(ext.|xfs)",job="node-exporter"} / node_filesystem_size{fstype=~"(ext.|xfs)",job="node-exporter"}
	* 100 <= 10
      for: 15m
      labels:
	service: node
	severity: warning
      annotations:
	description: 'Low disk space left on {{ $labels.mountpoint }} on {{ $labels.instance }}: {{ $value | humanize }}%'

    - alert: NodeNoDiskSpaceLeft
      expr: node_filesystem_avail{fstype=~"(ext.|xfs)",job="node-exporter"} / node_filesystem_size{fstype=~"(ext.|xfs)",job="node-exporter"}
	* 100 <= 1
      for: 15m
      labels:
	service: node
	severity: critical
      annotations:
	description: 'No disk space left on {{ $labels.mountpoint }} on{{ $labels.instance }}: {{ $value | humanize }}%'

    - alert: NodeHighInodeUsage
      expr: node_filesystem_files_free{fstype=~"(ext.|xfs)",job="node-exporter"} / node_filesystem_files{fstype=~"(ext.|xfs)",job="node-exporter"}
	* 100 <= 20
      for: 15m
      labels:
	service: node
	severity: warning
      annotations:
	description: Free inodes on {{ $labels.instance }} on mountpoint {{ $labels.mountpoint }} is at {{ $value | printf "%.2f" }}%

    - alert: NodeHighCPU
      expr: max(instance_cpu:node_cpu_not_idle:rate5m) > 0.8
      for: 2h
      labels:
	service: node
	severity: warning
      annotations:
	description: CPU use percent is high on {{ $labels.instance }} for the past 2 hours

    - alert: NodeExtremelyHighCPU
      expr: max(instance_cpu:node_cpu_not_idle:rate5m) > 0.95
      for: 2h
      labels:
	service: node
	severity: critical
      annotations:
	description: CPU use percent is extremely high on {{ $labels.instance }} for the past 2 hours

    - alert: NodeRebooted
      expr: node_time - node_boot_time < 300
      for: 1m
      labels:
	service: node
	severity: warning
      annotations:
	description: Node {{ $labels.instance }} was rebooted {{ $value }} seconds ago
