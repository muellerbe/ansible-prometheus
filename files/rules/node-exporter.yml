groups:
- name: node-exporter
  rules:
  - alert: LowDiskSpace
    expr: node_filesystem_avail{fstype=~"(ext.|xfs)",job="node-exporter"} / node_filesystem_size{fstype=~"(ext.|xfs)",job="node-exporter"}
      * 100 <= 10
    for: 15m
    labels:
      severity: critical
    annotations:
      description: Consider sshing into the instance and removing old logs or clean
        temp files following the linked runbook. For status check http://performance.gitlab.net/dashboard/db/fleet-overview
      runbook: troubleshooting/filesystem_alerts.md
      title: 'Really low disk space left on {{ $labels.mountpoint }} on {{ if $labels.fqdn
        }}{{ $labels.fqdn }}{{ else }}{{ $labels.instance }}{{ end }}: {{ $value |
        humanize }}%'
  - alert: NoDiskSpace
    expr: node_filesystem_avail{fstype=~"(ext.|xfs)",job="node-exporter"} / node_filesystem_size{fstype=~"(ext.|xfs)",job="node-exporter"}
      * 100 <= 1
    for: 15m
    labels:
      severity: critical
    annotations:
      description: There's only 1% disk space left on host {{ if $labels.fqdn }}{{
        $labels.fqdn }}{{ else }}{{ $labels.instance }}{{ end }}
      runbook: troubleshooting/filesystem_alerts.md
      title: 'No disk space left on {{ $labels.mountpoint }} on {{ if $labels.fqdn
        }}{{ $labels.fqdn }}{{ else }}{{ $labels.instance }}{{ end }}: {{ $value |
        humanize }}%'
  - alert: HighInodeUsage
    expr: node_filesystem_files_free{fstype=~"(ext.|xfs)",job="node-exporter"} / node_filesystem_files{fstype=~"(ext.|xfs)",job="node-exporter"}
      * 100 <= 20
    for: 15m
    labels:
      severity: critical
    annotations:
      description: Consider ssh'ing into the instance and removing files or clean
        temp files following the linked runbook. For status check http://performance.gitlab.net/dashboard/db/fleet-overview
      runbook: troubleshooting/filesystem_alerts_inodes.md
      title: Free inodes on {{ if $labels.fqdn }}{{ $labels.fqdn }}{{ else }}{{ $labels.instance
        }}{{ end }} on mountpoint {{ $labels.mountpoint }} is at {{ $value | printf
        "%.2f" }}%
  - alert: ExtremelyHighCPU
    expr: max(instance_cpu:node_cpu_not_idle:rate5m{environment=~"prd|cny"}) > 0.95
    for: 2h
    labels:
      severity: critical
    annotations:
      description: CPU use percent is extremely high on {{ if $labels.fqdn }}{{ $labels.fqdn
        }}{{ else }}{{ $labels.instance }}{{ end }} for the past 2 hours.
      runbook: troubleshooting
      title: CPU use percent is extremely high on {{ if $labels.fqdn }}{{ $labels.fqdn
        }}{{ else }}{{ $labels.instance }}{{ end }} for the past 2 hours.
  - alert: HighCPU
    expr: max(instance_cpu:node_cpu_not_idle:rate5m{environment=~"prd|cny"}) > 0.8
    for: 2h
    labels:
      severity: critical
    annotations:
      description: CPU use percent is extremely high on {{ if $labels.fqdn }}{{ $labels.fqdn
        }}{{ else }}{{ $labels.instance }}{{ end }} for the past 2 hours.
      runbook: troubleshooting
      title: CPU use percent is high on {{ if $labels.fqdn }}{{ $labels.fqdn }}{{
        else }}{{ $labels.instance }}{{ end }} for the past 2 hours.
